{% extends 'unfold/layouts/base_simple.html' %}
{% load i18n %}

{% block breadcrumbs %}{% endblock %}

{% block title %}
    {% if subtitle %}
        {{ subtitle }} |
    {% endif %}
    {{ title }} | {{ site_title|default:_('Django site admin') }}
{% endblock %}

{% block branding %}
    {% include "unfold/helpers/site_branding.html" %}
{% endblock %}

{% block content %}
<style>
    .dashboard-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
    }

    .dashboard-card {
        flex: 1;
        min-width: 250px;
        max-width: 300px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 20px;
        text-align: center;
    }

    .dashboard-card h3 {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
    }

    .dashboard-card p {
        font-size: 28px;
        font-weight: bold;
        margin: 0;
    }

    .balance {
        color: #007bff;
    }

    .payable {
        color: #dc3545;
    }

    .receivable {
        color: #28a745;
    }
    
    /* Added Styles for Tabs and Table */
    .tabs-container {
        margin: 20px;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .tabs {
        display: flex;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        overflow-x: auto;
    }
    
    .tab {
        padding: 12px 20px;
        cursor: pointer;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        white-space: nowrap;
    }
    
    .tab.active {
        border-bottom: 3px solid #007bff;
        color: #007bff;
    }
    
    .tab-content {
        display: none;
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-top: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .inventory-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .inventory-table th {
        background-color: #f8f9fa;
        padding: 12px;
        border-bottom: 2px solid #ddd;
        cursor: pointer;
    }
    
    .inventory-table th.sorted-asc::after {
        content: " ▲";
        font-size: 14px;
    }
    
    .inventory-table th.sorted-desc::after {
        content: " ▼";
        font-size: 14px;
    }
    
    .inventory-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
    }
    
    .inventory-table th:nth-child(1),
    .inventory-table td:nth-child(1) {
        text-align: left;
    }
    
    .inventory-table th:nth-child(2),
    .inventory-table td:nth-child(2) {
        text-align: center;
    }
    
    .inventory-table th:nth-child(3),
    .inventory-table td:nth-child(3) {
        text-align: left;
    }
    
    .inventory-table th:nth-child(4),
    .inventory-table td:nth-child(4) {
        text-align: center;
    }
    
    .inventory-table th:nth-child(5),
    .inventory-table td:nth-child(5),
    .inventory-table th:nth-child(6),
    .inventory-table td:nth-child(6),
    .inventory-table th:nth-child(7),
    .inventory-table td:nth-child(7) {
        text-align: right;
    }
    
    .inventory-table tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        flex-grow: 1;
    }
    
    .shop-info {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    
    .shop-name {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .shop-inventory-value {
        font-size: 18px;
        color: #007bff;
        font-weight: bold;
    }
    
    .shop-products-count {
        font-size: 16px;
        color: #555;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 10px;
    }
    
    .pagination-button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
    }
    
    .pagination-button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .pagination-button:hover:not(.active) {
        background-color: #f8f9fa;
    }
    
    .no-data {
        text-align: center;
        padding: 30px;
        color: #777;
    }
    
    .loading {
        text-align: center;
        padding: 30px;
        color: #777;
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-card">
        <h3>Total Balance</h3>
        <p id="total-balance" class="balance">Loading...</p>
    </div>
    <div class="dashboard-card">
        <h3>Total Payables</h3>
        <p id="total-payable" class="payable">Loading...</p>
    </div>
    <div class="dashboard-card">
        <h3>Total Receivables</h3>
        <p id="total-receivables" class="receivable">Loading...</p>
    </div>
</div>

<!-- Shop Inventory Tabs and Tables -->
<div class="tabs-container">
    <div class="tabs" id="shop-tabs">
        <div class="tab active" data-shop-id="all" onclick="switchTab('all')">All Shops</div>
        <!-- Shop tabs will be dynamically added here -->
        <div class="tab" data-shop-id="loading" style="display: none;">Loading shops...</div>
    </div>
    
    <div id="content-all" class="tab-content active">
        <!-- All Shops Total Inventory Value Summary -->
        <div class="shop-info">
            <div class="shop-name">All Shops Summary</div>
            <div class="shop-inventory-value">Total Inventory Value: <span id="all-shops-inventory-value">Loading...</span></div>
            <div class="shop-products-count">Total Products: <span id="all-shops-products-count">Loading...</span></div>
        </div>
        
        <div class="filters-container">
            <input type="text" id="all-filter-product" class="filter-input" placeholder="Filter by product name...">
            <input type="number" id="all-filter-min-qty" class="filter-input" placeholder="Min quantity">
            <input type="number" id="all-filter-max-qty" class="filter-input" placeholder="Max quantity">
            <input type="number" id="all-filter-min-value" class="filter-input" placeholder="Min inventory value">
            <input type="number" id="all-filter-max-value" class="filter-input" placeholder="Max inventory value">
        </div>
        
        <table class="inventory-table" id="all-inventory-table">
            <thead>
                <tr>
                    <th data-sort="shop_name">Shop Name</th>
                    <th data-sort="product_id">Product ID</th>
                    <th data-sort="product_name">Product Name</th>
                    <th data-sort="quantity">Quantity</th>
                    <th data-sort="average_cost">Average Cost</th>
                    <th data-sort="selling_price">Selling Price</th>
                    <th data-sort="inventory_value">Inventory Value</th>
                </tr>
            </thead>
            <tbody id="all-inventory-body">
                <tr>
                    <td colspan="7" class="loading">Loading inventory data...</td>
                </tr>
            </tbody>
        </table>
        <div class="pagination" id="all-pagination"></div>
    </div>
    
    <!-- Individual shop content tabs will be dynamically added here -->
</div>

<script>
    // Global variables
    let allShops = [];
    let allInventoryData = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    
    // Function to switch between tabs
    function switchTab(shopId) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Deactivate all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activate selected tab and content
        document.querySelector(`.tab[data-shop-id="${shopId}"]`).classList.add('active');
        document.getElementById(`content-${shopId}`).classList.add('active');
    }

    // Function to format numbers with commas for thousands
    function formatNumber(value) {
        // Check if value is a string that can be parsed as a number
        if (typeof value === 'string' && !isNaN(parseFloat(value))) {
            return parseFloat(value).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return value; // Return original value if not a valid number
    }
    
    // Function to create inventory table row HTML
    function createInventoryRow(item, includeShop = true) {
        return `
            <tr>
                ${includeShop ? `<td>${item.shop_name || ''}</td>` : ''}
                <td>${item.product_id}</td>
                <td>${item.product_name}</td>
                <td>${item.quantity}</td>
                <td>${formatNumber(item.average_cost)}</td>
                <td>${formatNumber(item.selling_price)}</td>
                <td>${formatNumber(item.inventory_value)}</td>
            </tr>
        `;
    }
    
    // Function to create shop info HTML
    function createShopInfo(shop) {
        return `
            <div class="shop-info">
                <div class="shop-name">${shop.name}</div>
                <div class="shop-inventory-value">Total Inventory Value: ${formatNumber(shop.total_inventory_value)}</div>
                <div class="shop-products-count">Total Products: ${shop.total_products}</div>
            </div>
        `;
    }
    
    // Function to create pagination
    function createPagination(totalItems, currentPage, containerId) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const paginationContainer = document.getElementById(containerId);
        paginationContainer.innerHTML = '';
        
        // Previous button
        if (totalPages > 1) {
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-button';
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => goToPage(currentPage - 1, containerId);
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-button ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.onclick = () => goToPage(i, containerId);
                paginationContainer.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-button';
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => goToPage(currentPage + 1, containerId);
            paginationContainer.appendChild(nextButton);
        }
    }
    
    // Function to go to a specific page
    function goToPage(page, paginationId) {
        currentPage = page;
        const shopId = paginationId.replace('-pagination', '');
        
        if (shopId === 'all') {
            displayAllInventory(filterAllInventory());
        } else {
            const shopInventory = filterShopInventory(shopId);
            displayShopInventory(shopId, shopInventory);
        }
    }
    
    // Function to sort table
    function sortTable(tableId, sortBy, order = 'asc') {
        const table = document.getElementById(tableId);
        const headerCells = table.querySelectorAll('th');
        
        // Reset all header styles
        headerCells.forEach(cell => {
            cell.classList.remove('sorted-asc', 'sorted-desc');
        });
        
        // Set the active sort header
        const activeHeader = table.querySelector(`th[data-sort="${sortBy}"]`);
        activeHeader.classList.add(order === 'asc' ? 'sorted-asc' : 'sorted-desc');
        
        // Determine which inventory to sort
        const shopId = tableId.replace('-inventory-table', '');
        let dataToSort;
        
        if (shopId === 'all') {
            dataToSort = filterAllInventory();
        } else {
            dataToSort = filterShopInventory(shopId);
        }
        
        // Sort the data
        dataToSort.sort((a, b) => {
            let valueA = a[sortBy];
            let valueB = b[sortBy];
            
            // Handle numeric values
            if (!isNaN(parseFloat(valueA)) && !isNaN(parseFloat(valueB))) {
                valueA = parseFloat(valueA);
                valueB = parseFloat(valueB);
            } else if (typeof valueA === 'string' && typeof valueB === 'string') {
                // Case-insensitive string comparison
                valueA = valueA.toLowerCase();
                valueB = valueB.toLowerCase();
            }
            
            if (valueA < valueB) return order === 'asc' ? -1 : 1;
            if (valueA > valueB) return order === 'asc' ? 1 : -1;
            return 0;
        });
        
        // Display the sorted data
        if (shopId === 'all') {
            displayAllInventory(dataToSort);
        } else {
            displayShopInventory(shopId, dataToSort);
        }
    }
    
    // Function to filter all inventory data
    function filterAllInventory() {
        const productFilter = document.getElementById('all-filter-product').value.toLowerCase();
        const minQty = document.getElementById('all-filter-min-qty').value;
        const maxQty = document.getElementById('all-filter-max-qty').value;
        const minValue = document.getElementById('all-filter-min-value').value;
        const maxValue = document.getElementById('all-filter-max-value').value;
        
        return allInventoryData.filter(item => {
            const matchesProduct = !productFilter || item.product_name.toLowerCase().includes(productFilter);
            const matchesMinQty = !minQty || item.quantity >= parseInt(minQty);
            const matchesMaxQty = !maxQty || item.quantity <= parseInt(maxQty);
            const matchesMinValue = !minValue || parseFloat(item.inventory_value) >= parseFloat(minValue);
            const matchesMaxValue = !maxValue || parseFloat(item.inventory_value) <= parseFloat(maxValue);
            
            return matchesProduct && matchesMinQty && matchesMaxQty && matchesMinValue && matchesMaxValue;
        });
    }
    
    // Function to filter shop inventory data
    function filterShopInventory(shopId) {
        const productFilter = document.getElementById(`${shopId}-filter-product`).value.toLowerCase();
        const minQty = document.getElementById(`${shopId}-filter-min-qty`).value;
        const maxQty = document.getElementById(`${shopId}-filter-max-qty`).value;
        const minValue = document.getElementById(`${shopId}-filter-min-value`).value;
        const maxValue = document.getElementById(`${shopId}-filter-max-value`).value;
        
        return allInventoryData.filter(item => {
            if (item.shop_id !== shopId) return false;
            
            const matchesProduct = !productFilter || item.product_name.toLowerCase().includes(productFilter);
            const matchesMinQty = !minQty || item.quantity >= parseInt(minQty);
            const matchesMaxQty = !maxQty || item.quantity <= parseInt(maxQty);
            const matchesMinValue = !minValue || parseFloat(item.inventory_value) >= parseFloat(minValue);
            const matchesMaxValue = !maxValue || parseFloat(item.inventory_value) <= parseFloat(maxValue);
            
            return matchesProduct && matchesMinQty && matchesMaxQty && matchesMinValue && matchesMaxValue;
        });
    }
    
    // Function to display all inventory data with pagination
    function displayAllInventory(filteredData) {
        const totalItems = filteredData.length;
        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const paginatedData = filteredData.slice(start, end);
        
        const tbody = document.getElementById('all-inventory-body');
        
        if (paginatedData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="no-data">No inventory data found</td></tr>';
        } else {
            tbody.innerHTML = paginatedData.map(item => createInventoryRow(item, true)).join('');
        }
        
        // Update all shops summary
        updateAllShopsSummary(allInventoryData);
        
        createPagination(totalItems, currentPage, 'all-pagination');
    }
    
    // Function to update the all shops summary
    function updateAllShopsSummary(data) {
        let totalValue = 0;
        let uniqueProducts = new Set();
        
        data.forEach(item => {
            totalValue += parseFloat(item.inventory_value || 0);
            uniqueProducts.add(item.product_id);
        });
        
        document.getElementById('all-shops-inventory-value').textContent = formatNumber(totalValue.toString());
        document.getElementById('all-shops-products-count').textContent = uniqueProducts.size;
    }
    
    // Function to display shop inventory data with pagination
    function displayShopInventory(shopId, filteredData) {
        const totalItems = filteredData.length;
        const start = (currentPage - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const paginatedData = filteredData.slice(start, end);
        
        const tbody = document.getElementById(`${shopId}-inventory-body`);
        
        if (paginatedData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="no-data">No inventory data found</td></tr>';
        } else {
            tbody.innerHTML = paginatedData.map(item => createInventoryRow(item, false)).join('');
        }
        
        createPagination(totalItems, currentPage, `${shopId}-pagination`);
    }
    
    // Function to create a tab and content for each shop
    function createShopTab(shop) {
        // Create tab
        const tabsContainer = document.getElementById('shop-tabs');
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.dataset.shopId = shop.id;
        tab.textContent = shop.name;
        tab.onclick = function() { switchTab(shop.id); };
        tabsContainer.appendChild(tab);
        
        // Create tab content
        const tabsContentContainer = document.querySelector('.tabs-container');
        const tabContent = document.createElement('div');
        tabContent.id = `content-${shop.id}`;
        tabContent.className = 'tab-content';
        
        // Create the shop information section
        tabContent.innerHTML = createShopInfo(shop);
        
        // Create filters
        const filtersContainer = document.createElement('div');
        filtersContainer.className = 'filters-container';
        filtersContainer.innerHTML = `
            <input type="text" id="${shop.id}-filter-product" class="filter-input" placeholder="Filter by product name...">
            <input type="number" id="${shop.id}-filter-min-qty" class="filter-input" placeholder="Min quantity">
            <input type="number" id="${shop.id}-filter-max-qty" class="filter-input" placeholder="Max quantity">
            <input type="number" id="${shop.id}-filter-min-value" class="filter-input" placeholder="Min inventory value">
            <input type="number" id="${shop.id}-filter-max-value" class="filter-input" placeholder="Max inventory value">
        `;
        tabContent.appendChild(filtersContainer);
        
        // Create table
        const table = document.createElement('table');
        table.className = 'inventory-table';
        table.id = `${shop.id}-inventory-table`;
        table.innerHTML = `
            <thead>
                <tr>
                    <th data-sort="product_id">Product ID</th>
                    <th data-sort="product_name">Product Name</th>
                    <th data-sort="quantity">Quantity</th>
                    <th data-sort="average_cost">Average Cost</th>
                    <th data-sort="selling_price">Selling Price</th>
                    <th data-sort="inventory_value">Inventory Value</th>
                </tr>
            </thead>
            <tbody id="${shop.id}-inventory-body">
                <tr>
                    <td colspan="6" class="loading">Loading inventory data...</td>
                </tr>
            </tbody>
        `;
        tabContent.appendChild(table);
        
        // Create pagination
        const pagination = document.createElement('div');
        pagination.className = 'pagination';
        pagination.id = `${shop.id}-pagination`;
        tabContent.appendChild(pagination);
        
        tabsContentContainer.appendChild(tabContent);
        
        // Add event listeners for sorting
        const headerCells = table.querySelectorAll('th');
        headerCells.forEach(cell => {
            cell.addEventListener('click', function() {
                const sortBy = this.dataset.sort;
                const currentOrder = this.classList.contains('sorted-asc') ? 'desc' : 'asc';
                sortTable(`${shop.id}-inventory-table`, sortBy, currentOrder);
            });
        });
        
        // Add event listeners for filtering
        const filterInputs = filtersContainer.querySelectorAll('input');
        filterInputs.forEach(input => {
            input.addEventListener('input', function() {
                currentPage = 1; // Reset to first page when filtering
                const shopInventory = filterShopInventory(shop.id);
                displayShopInventory(shop.id, shopInventory);
            });
        });
    }
    
    // Function to setup the all inventory tab
    function setupAllInventoryTab() {
        // Add event listeners for sorting
        const headerCells = document.querySelectorAll('#all-inventory-table th');
        headerCells.forEach(cell => {
            cell.addEventListener('click', function() {
                const sortBy = this.dataset.sort;
                const currentOrder = this.classList.contains('sorted-asc') ? 'desc' : 'asc';
                sortTable('all-inventory-table', sortBy, currentOrder);
            });
        });
        
        // Add event listeners for filtering
        const filterInputs = document.querySelectorAll('#content-all .filter-input');
        filterInputs.forEach(input => {
            input.addEventListener('input', function() {
                currentPage = 1; // Reset to first page when filtering
                displayAllInventory(filterAllInventory());
            });
        });
    }
    
    // Fetch and display financial data
    async function fetchFinancialData() {
        try {
            // Fetch financial data
            const [balanceRes, payableRes, receivableRes] = await Promise.all([
                fetch('/api/account/total-balance/'),
                fetch('/api/purchase_invoice/total-payable/'),
                fetch('/api/sale_invoice/total-receivables/')
            ]);

            const balanceData = await balanceRes.json();
            const payableData = await payableRes.json();
            const receivableData = await receivableRes.json();
            
            document.getElementById('total-balance').textContent = formatNumber(balanceData.total_balance);
            document.getElementById('total-payable').textContent = formatNumber(payableData.total_payable);
            document.getElementById('total-receivables').textContent = formatNumber(receivableData.total_receivables);
        } catch (error) {
            console.error("Error fetching financial data", error);
            document.getElementById('total-balance').textContent = "Error";
            document.getElementById('total-payable').textContent = "Error";
            document.getElementById('total-receivables').textContent = "Error";
        }
    }
    
    // Fetch shop data and create tabs
    async function fetchShops() {
        try {
            const response = await fetch('/api/shop/');
            allShops = await response.json();
            
            // Remove loading tab
            document.querySelector('.tab[data-shop-id="loading"]').style.display = 'none';
            
            // Create tabs for each shop
            for (const shop of allShops) {
                // Get shop inventory data
                try {
                    const inventoryRes = await fetch(`/api/inventory/inventory-value/?shop_id=${shop.id}`);
                    const inventoryData = await inventoryRes.json();
                    
                    // Add shop inventory data
                    shop.total_inventory_value = inventoryData.total_inventory_value;
                    shop.total_products = inventoryData.products.length;
                    
                    // Add inventory data to global array
                    inventoryData.products.forEach(product => {
                        product.shop_id = shop.id.toString();
                        product.shop_name = shop.name;
                        allInventoryData.push(product);
                    });
                    
                    // Create tab for this shop
                    createShopTab(shop);
                    
                    // Populate the shop's inventory table
                    const shopInventory = allInventoryData.filter(item => item.shop_id === shop.id.toString());
                    displayShopInventory(shop.id.toString(), shopInventory);
                    
                } catch (inventoryError) {
                    console.error(`Error fetching inventory for shop ${shop.id}`, inventoryError);
                }
            }
            
            // Setup all inventory tab and populate it
            setupAllInventoryTab();
            displayAllInventory(allInventoryData);
            
        } catch (error) {
            console.error("Error fetching shops", error);
            document.querySelector('.tab[data-shop-id="loading"]').textContent = "Error loading shops";
            document.querySelector('.tab[data-shop-id="loading"]').style.display = 'block';
        }
    }
    
    // Initialize data fetch when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        fetchFinancialData();
        fetchShops();
    });
</script>
{% endblock %}