{% extends 'unfold/layouts/base_simple.html' %}
{% load i18n %}

{% block breadcrumbs %}{% endblock %}

{% block title %}
    {% if subtitle %}
        {{ subtitle }} |
    {% endif %}
    {{ title }} | {{ site_title|default:_('Django site admin') }}
{% endblock %}

{% block branding %}
    {% include "unfold/helpers/site_branding.html" %}
{% endblock %}

{% block content %}
<style>
    .dashboard-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
    }

    .dashboard-card {
        flex: 1;
        min-width: 250px;
        max-width: 300px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 20px;
        text-align: center;
    }

    .dashboard-card h3 {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
    }

    .dashboard-card p {
        font-size: 28px;
        font-weight: bold;
        margin: 0;
    }

    .balance {
        color: #007bff;
    }

    .payable {
        color: #dc3545;
    }

    .receivable {
        color: #28a745;
    }
    
    .inventory {
        color: #6610f2;
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-card">
        <h3>Total Balance</h3>
        <p id="total-balance" class="balance">Loading...</p>
    </div>
    <div class="dashboard-card">
        <h3>Total Payables</h3>
        <p id="total-payable" class="payable">Loading...</p>
    </div>
    <div class="dashboard-card">
        <h3>Total Receivables</h3>
        <p id="total-receivables" class="receivable">Loading...</p>
    </div>
    <div class="dashboard-card">
        <h3>Inventory Value(ZIM)</h3>
        <p id="total-inventory" class="inventory">Loading...</p>
    </div>
</div>

<script>
    async function fetchSummaryData() {
        try {
            const [balanceRes, payableRes, receivableRes, inventoryRes] = await Promise.all([
                fetch('/api/account/total-balance/'),
                fetch('/api/purchase_invoice/total-payable/'),
                fetch('/api/sale_invoice/total-receivables/'),
                fetch('/api/inventory/inventory-value/?shop_id=2')
            ]);

            const balanceData = await balanceRes.json();
            const payableData = await payableRes.json();
            const receivableData = await receivableRes.json();
            const inventoryData = await inventoryRes.json();

            // Format numbers with commas for thousands
            const formatNumber = (value) => {
                // Check if value is a string that can be parsed as a number
                if (typeof value === 'string' && !isNaN(parseFloat(value))) {
                    return parseFloat(value).toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
                return value; // Return original value if not a valid number
            };
            
            document.getElementById('total-balance').textContent = formatNumber(balanceData.total_balance);
            document.getElementById('total-payable').textContent = formatNumber(payableData.total_payable);
            document.getElementById('total-receivables').textContent = formatNumber(receivableData.total_receivables);
            document.getElementById('total-inventory').textContent = formatNumber(inventoryData.total_inventory_value);
        } catch (error) {
            console.error("Error fetching dashboard data", error);
            document.getElementById('total-balance').textContent = "Error";
            document.getElementById('total-payable').textContent = "Error";
            document.getElementById('total-receivables').textContent = "Error";
            document.getElementById('total-inventory').textContent = "Error";
        }
    }

    document.addEventListener('DOMContentLoaded', fetchSummaryData);
</script>
{% endblock %}