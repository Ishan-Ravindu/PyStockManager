{% extends "admin/base_site.html" %}
{% load i18n static jazzmin %}
{% get_jazzmin_ui_tweaks as jazzmin_ui %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block content_title %} {% trans 'Dashboard' %} {% endblock %}

{% block breadcrumbs %}
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin:index' %}">{% trans 'Home' %}</a></li>
        <li class="breadcrumb-item">{% trans 'Dashboard' %}</li>
    </ol>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch financial data
        axios.get('/api/purchase_invoice/total-payable/')
            .then(function(response) {
                document.getElementById('total-payable').innerText = 'Rs. ' + parseFloat(response.data.total_payable).toFixed(2);
            })
            .catch(function(error) {
                console.error('Error fetching total payable:', error);
            });
        axios.get('/api/sale_invoice/total-receivables/')
            .then(function(response) {
                document.getElementById('total-receivables').innerText = 'Rs. ' + parseFloat(response.data.total_receivables).toFixed(2);
            })
            .catch(function(error) {
                console.error('Error fetching total receivables:', error);
            });
        axios.get('/api/account/total-balance/')
            .then(function(response) {
                document.getElementById('total-balance').innerText = 'Rs. ' + parseFloat(response.data.total_balance).toFixed(2);
            })
            .catch(function(error) {
                console.error('Error fetching total balance:', error);
            });
            
        axios.get('/api/history/recent-history/?days=1&limit=10')
            .then(function(response) {
                const recentChangesContainer = document.getElementById('recent-changes-container');
                recentChangesContainer.innerHTML = '';

                const changes = response.data.results
                
                if (changes.length === 0) {
                    recentChangesContainer.innerHTML = '<p class="text-muted">No recent changes found.</p>';
                    return;
                }
                
                changes.forEach(function(change) {
                    const changeDate = new Date(change.history_date);
                    const formattedDate = changeDate.toLocaleString();

                    let badgeClass = 'badge badge-info';
                    let changeType = 'Updated';

                    if (change.history_type === '+') {
                        badgeClass = 'badge badge-success';
                        changeType = 'Created';
                    } else if (change.history_type === '-') {
                        badgeClass = 'badge badge-danger';
                        changeType = 'Deleted';
                    }

                    let changedFieldsText = '';
                    if (change.changed_fields && Object.keys(change.changed_fields).length > 0) {
                        const fieldNames = Object.keys(change.changed_fields)
                            .filter(field => !['id', 'history_user'].includes(field))
                            .map(field => {
                                const fieldData = change.changed_fields[field];
                                if (fieldData.old_value !== null && fieldData.new_value !== null) {
                                    return `<span class="font-weight-bold">${field}</span>: <span class="text-danger">${fieldData.old_value}</span> â†’ <span class="text-success">${fieldData.new_value}</span>`;
                                } else if (fieldData.new_value !== null) {
                                    return `<span class="font-weight-bold">${field}</span>: ${fieldData.new_value}`;
                                }
                                return field;
                            })
                            .slice(0, 5)
                            .join('<br>');
                            
                        if (fieldNames) {
                            changedFieldsText = `<small class="text-muted">${fieldNames}</small>`;
                        }
                    }

                    const modelParts = change.model_name.split('.');
                    const modelName = modelParts[modelParts.length - 1].replace('Historical', '');

                    const username = change.history_user ? change.history_user.username : 'Unknown';

                    let instanceName = change.instance_name;
                    if (instanceName.includes(" as of ")) {
                        instanceName = instanceName.split(" as of ")[0];
                    }

                    let reasonText = '';
                    if (change.history_change_reason) {
                        reasonText = `<div class="mt-1"><small class="text-muted font-italic">"${change.history_change_reason}"</small></div>`;
                    }

                    const changeItem = document.createElement('div');
                    changeItem.className = 'border-bottom py-2';
                    changeItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span><span class="${badgeClass}">${changeType}</span> ${modelName}</span>
                            <small class="text-muted">${formattedDate}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${instanceName}</strong>
                            <small class="text-primary"><i class="fas fa-user mr-1"></i>${username}</small>
                        </div>
                        <div class="mt-1">${changedFieldsText}</div>
                        ${reasonText}
                    `;
                    
                    recentChangesContainer.appendChild(changeItem);
                });
            })
            .catch(function(error) {
                console.error('Error fetching recent history:', error);
                document.getElementById('recent-changes-container').innerHTML = 
                    '<div class="alert alert-danger">Error loading recent changes.</div>';
            });
    });
</script>

<style>
    #recent-changes-container .border-bottom:last-child {
        border-bottom: none !important;
    }
    .change-badge {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
    }
    /* Removed scroller */
</style>
{% endblock %}

{% block content %}
    <div class="col-lg-9 col-12">
        <div class="row">
            <div class="col-md-6 col-sm-12">
                <!-- Stats Cards -->
                <div class="card bg-gradient-danger mb-4">
                    <div class="card-header">
                        <h5 class="m-0">
                            <i class="fas fa-money-bill-alt mr-2"></i>
                            Total Payable
                        </h5>
                    </div>
                    <div class="card-body">
                        <h2 class="lead"><b id="total-payable">Loading...</b></h2>                        
                    </div>
                </div>
                
                <div class="card bg-gradient-success mb-4">
                    <div class="card-header">
                        <h5 class="m-0">
                            <i class="fas fa-hand-holding-usd mr-2"></i>
                            Total Receivables
                        </h5>
                    </div>
                    <div class="card-body">
                        <h2 class="lead"><b id="total-receivables">Loading...</b></h2>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-12">
                <!-- Right column dashboard cards -->
                <div class="card bg-gradient-primary mb-4">
                    <div class="card-header">
                        <h5 class="m-0">
                            <i class="fas fa-university mr-2"></i>
                            Total Account Balances
                        </h5>
                    </div>
                    <div class="card-body">
                        <h2 class="lead"><b id="total-balance">Loading...</b></h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-12">
        <div id="content-related">
            <div class="module" id="custom-info-module">
                <h4 class="mb-3"><i class="fas fa-history mr-2"></i>Today's Activity</h4>
                <div class="card bg-white mb-3">
                    <div class="card-body p-0">
                        <div id="recent-changes-container" class="p-3">
                            <div class="d-flex justify-content-center align-items-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <span class="ml-2">Loading recent changes...</span>
                            </div>
                        </div>
                    </div>
                </div>               
               
            </div>
        </div>
    </div>
{% endblock %}